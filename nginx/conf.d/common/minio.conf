
server {
    listen 80;                              # ðŸŒ Le proxy Ã©coute sur le port HTTP public (80)
    server_name minio.storecashflow.ma;     # ðŸ·ï¸ Nom de domaine externe (visible cÃ´tÃ© client)

    location / {

        if ($request_method !~ ^(GET|HEAD)$) {
            return 405;  # ðŸš« MÃ©thode non autorisÃ©e
        }

        # ðŸ”’ VÃ©rifie que la requÃªte contient bien une signature presigned URL
        if ($query_string !~* "X-Amz-") {
            return 403;  # ðŸš« Pas de signature => refusÃ©
        }
        
        proxy_pass http://minio:9000;       # ðŸ” Redirection interne vers le conteneur MinIO
                                            #    (ceci est lâ€™adresse INTERNE du rÃ©seau Docker)

        # âš™ï¸ Ces lignes sont CRUCIALES ðŸ‘‡

        proxy_set_header Host $host;        # ðŸ§  ðŸ’¡ Nginx conserve le nom dâ€™hÃ´te dâ€™origine du client :
                                            #    ex: "minio.storecashflow.ma"
                                            #    => ainsi, MinIO "pense" toujours Ãªtre contactÃ©
                                            #       directement sur ce domaine.
                                            #    Câ€™est ce qui permet aux pre-signed URLs de rester valides.

        proxy_set_header X-Real-IP $remote_addr;         # ðŸ‘¤ Envoie Ã  MinIO lâ€™adresse IP rÃ©elle du client
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # ðŸ“¦ Historique des IPs traversÃ©es
        proxy_set_header X-Forwarded-Proto $scheme;      # ðŸ”’ Informe MinIO que la requÃªte initiale
                                                         #    venait en HTTPS (et non en HTTP interne)
                                                         #    => important pour les signatures et les redirections.
    }
}